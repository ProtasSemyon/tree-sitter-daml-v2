module Splice.Amulet where

import Prelude
import DA.Action (void)
import DA.Assert
import DA.Map as Map
import DA.TextMap as TextMap
import DA.Optional (fromOptional)

data AmuletCreateSummary amuletContractId = AmuletCreateSummary with
    amulet : amuletContractId -- ^ The new amulet that was created
    amuletPrice : Decimal -- ^ The amulet price at the round the amulet was created
    round: Round -- ^ Round for which this amulet was created.
  deriving (Eq, Show)
  
template Amulet
  with
    dso : Party
    owner : Party
    amount : ExpiringAmount
  where
    signatory dso, owner
    ensure validExpiringAmount amount

    nonconsuming choice Amulet_Expire : Amulet_ExpireResult
      with
        roundCid : ContractId OpenMiningRound
      controller dso
      do requireAmuletExpiredForAllOpenRounds roundCid this


    interface instance Api.Token.HoldingV1.Holding for Amulet where
      view = Api.Token.HoldingV1.HoldingView with
        owner
        instrumentId = amuletInstrumentId dso
        amount = amount.txt.initialAmount
        lock = None
        meta = amuletMetadata this
